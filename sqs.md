# SQS

## プロデューサーとコンシューマー

## キューの種類

標準キュー: 入れた順番と出る順番に規則性はない。また1つ入れたものが2回以上出てくることもある。アプリケーション側で冪等性を担保する必要がある。

FIFOキュー: 順番と出る回数が担保されている。

## ロングポーリングとショートポーリングの違い

<https://docs.aws.amazon.com/ja_jp/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-short-and-long-polling.html>

## デッドレターキュー

公式の説明
<https://docs.aws.amazon.com/ja_jp/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html>

デッドレターキューとは

    正常に処理できないメッセージが送られるキュー
        例えばコンシューマーが5回以上メッセージを受信してもメッセージが削除されない場合に、メッセージが送られてくる

使い方

    SQSを2つ作って、片方のSQSをキュー、もう片方をデッドレターキューとして使う
    キューにてデッドレターキューを指定する。またデッドレターキューに渡すまでのポーリング回数を指定する。
    （ポーリングされた後うまく処理されたら削除されるはずなのに、それが何回もされないということは問題のあるメッセージということ）

制約

    * FIFOキューのデッドレターキューはFIFOである必要があり、標準キューのデッドレターキューは標準キューである必要がある
    * キューとデッドレターキューは同じリージョンに存在する必要がある
    * デッドレターキューには保存期間があり、３日などで削除する。

嬉しいこと

    正しく処理できなかったメッセージだけが格納されるので、失敗処理を分析しやすい

    * デッドレターキューに配信されたメッセージに関するアラームを設定する。
    * ログを調べて、メッセージがデッドレターキューに配信される原因となった可能性のある例外を特定する。
    * デッドレターキューに配信されたメッセージの内容を分析し、ソフトウェアに関する問題や、プロデューサーまたはコンシューマーのハードウェアに関する問題を診断する。
    * コンシューマーがメッセージを処理するために十分な時間が設定されているかどうかを調べる。

考えたこと（以下を整理すればいいのでは）

    デッドレターキューに入っただけではどんな例外かわからないので、クライアントにどんな通知をするべきかわからない。
    例外がシステム例外か業務例外か調べて、適切なメッセージを通知する必要がある。

    * デッドレターキューにどんなメッセージが格納されるのか
    * 格納されたメッセージをどうやって処理してクライアントに返せば良いのか

## コンシューマーの種類

    lambda
    fargate
    EC2

    それぞれの実装方法の違い

## 参考

クラソル
<https://business.ntt-east.co.jp/content/cloudsolution/column-135.html>
